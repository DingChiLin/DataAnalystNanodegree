<html>
<div id="chartContainer">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.2.0.min.js"></script>

  <style>
    circle {
      'r':10
    }
  </style>

  <script type="text/javascript">
    var svg = dimple.newSvg("#chartContainer", 1200, 800);
    d3.csv("./pisa2012_transform.csv", function (data) {
      console.log(data[0]);
      drawChart(data, ['Chinese Taipei'])
    });

    function drawChart(data, highlightCountrys){
      var mathData = [];
      var languageData = [];
      var scienceData = [];

      subjectList = ['Math', 'Language', 'Science']
      splitData = [];

      for(var s_index in subjectList){
        splitData[s_index] = []
        for(var index in data){
          splitData[s_index][index] = {}
          splitData[s_index][index]['Country'] = data[index]['Country']
          splitData[s_index][index]['ICTResourcesClass'] = data[index]['ICTResourcesClass']
          splitData[s_index][index]['LearningTime'] = data[index][ subjectList[s_index] + 'LearningTime']
          splitData[s_index][index]['Score'] = data[index][ subjectList[s_index] + 'Score']

          if(highlightCountrys.indexOf(data[index]['Country'])==-1){
            splitData[s_index][index]['Size'] = 10
          }else{
            splitData[s_index][index]['Size'] = 13
          }
        }
      }

      var myChart = new dimple.chart(svg, splitData[0]);
      myChart.setBounds(60, 100, 800, 500)

      var x = myChart.addMeasureAxis("x", "Score");
      x.overrideMin = 350;
      x.overrideMax = 600;

      //上課時數
      var y = myChart.addMeasureAxis("y", "LearningTime");
      y.overrideMin = 100;
      y.overrideMax = 400;

      //控制大小
      var z = myChart.addMeasureAxis("z", "Size");
      z.overrideMin = 5
      z.overrideMax = 40;

      //['國家', ‘科技使用程度’]
      var s = myChart.addSeries(["Country", "ICTResourcesClass"], dimple.plot.bubble);
      s.stacked = false;
      s.addOrderRule(['ICTResourcesClass'], true)
      s.afterDraw = function (s, d) {
        //d3.select(s).attr("r", 10)
        console.log(s.id)
        console.log(d)

        d3.select('#dimple-chinese-taipei-b----')
        .style('stroke', 'red')
        .attr('stroke-width', '2px')
        .text(d.key)
      }

      // 可以做科技用具程度差異顏色表
      myChart.assignColor("A", "#063870", "white", 1);
      myChart.assignColor("B", "#0D51B0", "white", 1);
      myChart.assignColor("C", "#3188E8", "white", 1);
      myChart.assignColor("D", "#6CB0F8", "white", 1);
      myChart.assignColor("E", "#B3D9FD", "white", 1);

      myChart.addLegend(60, 10, 610, 20, "right")
      myChart.draw(1000).svg.selectAll("circle.dimple-series-0").attr("r", 10)
            //changeStyle()

      setTimeout(function(){
        update(myChart, splitData[2])
      }, 4000);

    }

    function update(myChart, data){
      //考試分數
      myChart.data = data
      myChart.draw(1000)

      //changeStyle()
    }

    function changeStyle(){
            // 增大方塊size
      d3.selectAll("circle.dimple-series-0")
        .attr("r", 10)

      // 國家 Highlight 直接改
      //d3.select('#dimple-chinese-taipei-----')
      //  .style('fill', 'red')

      d3.select('#dimple-chinese-taipei-b----')
        .style('stroke', 'red')
        .attr('stroke-width', '2px')

      d3.selectAll('text.dimple-axis')
        .style("font-size", "15px")

      //$(".dimple-legend").hide()
    }


  </script>
</div>
</html>
